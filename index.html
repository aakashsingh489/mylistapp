<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LetsWatch</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-image: url("bg.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.55);
      z-index: -1;
    }

    .container {
      max-width: 720px;
      margin: 40px auto;
      background: rgba(255, 255, 255, 0.92);
      padding: 22px;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      backdrop-filter: blur(4px);
    }

    h1 {
      margin: 0 0 20px;
      font-size: 24px;
      text-align: center;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .card {
      border: 1px solid #eee;
      border-radius: 14px;
      padding: 14px;
      background: rgba(255, 255, 255, 0.95);
      min-height: 140px;
      cursor: pointer;
      transition: 0.2s;
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 18px;
      position: relative;
      z-index: 2;
    }

    .card p, .card ul {
      position: relative;
      z-index: 2;
    }

    .card-bg {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      opacity: 0.35;
      z-index: 1;
    }

    .small-list {
      margin: 0;
      padding-left: 18px;
      color: #444;
      font-size: 14px;
    }

    .bottom-bar {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      background: #4a78ff;
      color: white;
      transition: 0.2s;
    }

    button:hover {
      background: #365ee0;
    }

    .btn-secondary {
      background: #222;
    }

    .btn-secondary:hover {
      background: #000;
    }

    .btn-danger {
      background: #ff3b3b;
    }

    .btn-danger:hover {
      background: #d92c2c;
    }

    .hidden {
      display: none;
    }

    .screen-title {
      text-align: center;
      margin: 0 0 16px;
      font-size: 22px;
    }

    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    input {
      flex: 1;
      min-width: 200px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      outline: none;
      font-size: 15px;
    }

    input:focus {
      border-color: #4a78ff;
    }

    ul.main-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    ul.main-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 10px;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.95);
    }

    .delete-btn {
      background: #ff3b3b;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
    }

    .delete-btn:hover {
      background: #d92c2c;
    }

    .hint {
      font-size: 13px;
      color: #444;
      text-align: center;
      margin-top: 10px;
    }

    /* LIST SCREEN BACKGROUND */
    .list-screen {
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    .list-screen::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.72);
      border-radius: 14px;
      z-index: 0;
    }

    .list-screen > * {
      position: relative;
      z-index: 1;
    }

    @media (max-width: 620px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <!-- HOME SCREEN -->
  <div class="container" id="homeScreen">
    <h1>LetsWatch</h1>
    <div class="hint">ðŸ‘‡ Click any specific list to watch all the names</div>
    <div class="grid" id="homeGrid"></div>

    <div class="bottom-bar">
      <button onclick="openEditMenu()">Edit</button>
    </div>

    <div class="hint">ðŸ”’ Password is only required for Edit</div>
    <div class="hint">Everything is created by the one and only 'Aakash'</div>
  </div>

  <!-- EDIT SCREEN -->
  <div class="container hidden list-screen" id="editScreen">
    <h2 class="screen-title" id="editTitle">Editing</h2>

    <div class="input-row">
      <input id="editItemInput" type="text" placeholder="Add item..." />
      <button onclick="addItem()">Add</button>
    </div>

    <ul class="main-list" id="editList"></ul>

    <div class="bottom-bar">
      <button onclick="chooseBackgroundFromGallery()">Choose Background</button>
      <button class="btn-danger" onclick="removeListBackground()">Remove Background</button>
      <button class="btn-secondary" onclick="goHome()">â¬… Back</button>
    </div>

    <div class="hint">Press Enter to add item quickly</div>
  </div>

  <!-- VIEW SCREEN -->
  <div class="container hidden list-screen" id="viewScreen">
    <h2 class="screen-title" id="viewTitle">Viewing</h2>
    <ul class="main-list" id="viewList"></ul>

    <div class="bottom-bar">
      <button class="btn-secondary" onclick="goHome()">â¬… Back</button>
    </div>

    <div class="hint">ðŸ‘€ View only mode</div>
  </div>

  <!-- Hidden file input for gallery -->
  <input id="bgFileInput" type="file" accept="image/*" class="hidden" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ==========================
    // SUPABASE CONFIG
    // ==========================
    const SUPABASE_URL = "https://qbjpzbxyqxiylusqkppi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFianB6Ynh5cXhpeWx1c3FrcHBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyOTQzNTQsImV4cCI6MjA4Njg3MDM1NH0.W85MlPKyJrsAF1N3ej6Kp_KYcPhs8JdblBaBHL-LIrg";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==========================
    // LIST NAMES
    // ==========================
    const listKeys = ["buggy", "zainab", "parth", "aakash"];

    const listDisplayNames = {
      buggy: "Buggy",
      zainab: "Zainab",
      parth: "Parth",
      aakash: "Aakash"
    };

    // ==========================
    // APP STATE
    // ==========================
    let currentListKey = null;

    let lists = {
      buggy: [],
      zainab: [],
      parth: [],
      aakash: []
    };

    // ==========================
    // LOAD ALL LISTS
    // ==========================
    async function loadAllListsFromSupabase() {
      const { data, error } = await supabaseClient
        .from("lists")
        .select("list_key, items");

      if (error) {
        console.error("Supabase load error:", error);
        alert("Supabase error while loading lists âŒ\n\n" + error.message);
        return;
      }

      for (const k of listKeys) lists[k] = [];

      for (const row of data || []) {
        if (lists[row.list_key] !== undefined) {
          lists[row.list_key] = row.items || [];
        }
      }
    }

    async function saveOneListToSupabase(listKey) {
      const { error } = await supabaseClient
        .from("lists")
        .update({ items: lists[listKey] })
        .eq("list_key", listKey);

      if (error) {
        console.error("Supabase save error:", error);
        alert("Failed to save list online âŒ\n\n" + error.message);
      }
    }

    // ==========================
    // PASSWORDS (PER LIST)
    // ==========================
    async function getListPassword(listKey) {
      const { data, error } = await supabaseClient
        .from("list_passwords")
        .select("password")
        .eq("list_key", listKey)
        .maybeSingle();

      if (error) {
        console.error(error);
        return null;
      }

      if (!data) return null;

      const pass = data.password;
      if (!pass || pass.trim() === "") return null;

      return pass.trim();
    }

    async function setListPassword(listKey, newPassword) {
      const { error } = await supabaseClient
        .from("list_passwords")
        .upsert({
          list_key: listKey,
          password: newPassword
        });

      if (error) {
        console.error(error);
        alert("Failed to save password âŒ");
        return false;
      }

      return true;
    }

    // ==========================
    // STORAGE BACKGROUNDS
    // ==========================
    function getBgPath(listKey) {
      return `${listKey}.jpg`;
    }

    async function uploadBackgroundToSupabase(listKey, file) {
      const path = getBgPath(listKey);

      const { error } = await supabaseClient.storage
        .from("list-backgrounds")
        .upload(path, file, {
          upsert: true,
          contentType: file.type
        });

      if (error) {
        console.error("Upload error:", error);
        alert("Failed to upload background âŒ\n\n" + error.message);
        return false;
      }

      return true;
    }

    async function deleteBackgroundFromSupabase(listKey) {
      const path = getBgPath(listKey);

      const { error } = await supabaseClient.storage
        .from("list-backgrounds")
        .remove([path]);

      if (error) {
        console.error("Remove error:", error);
        alert("Failed to remove background âŒ\n\n" + error.message);
        return false;
      }

      return true;
    }

    function getBackgroundPublicUrl(listKey) {
      const path = getBgPath(listKey);

      const { data } = supabaseClient.storage
        .from("list-backgrounds")
        .getPublicUrl(path);

      return data?.publicUrl || null;
    }

    // ==========================
    // UI HELPERS
    // ==========================
    function hideAllScreens() {
      document.getElementById("homeScreen").classList.add("hidden");
      document.getElementById("editScreen").classList.add("hidden");
      document.getElementById("viewScreen").classList.add("hidden");
    }

    async function applyListScreenBackground(key) {
      const url = getBackgroundPublicUrl(key);

      const viewScreen = document.getElementById("viewScreen");
      const editScreen = document.getElementById("editScreen");

      if (!url) {
        viewScreen.style.backgroundImage = "";
        editScreen.style.backgroundImage = "";
        return;
      }

      const img = new Image();
      img.onload = () => {
        viewScreen.style.backgroundImage = `url('${url}?t=${Date.now()}')`;
        editScreen.style.backgroundImage = `url('${url}?t=${Date.now()}')`;
      };
      img.onerror = () => {
        viewScreen.style.backgroundImage = "";
        editScreen.style.backgroundImage = "";
      };
      img.src = url + "?t=" + Date.now();
    }

    // ==========================
    // HOME RENDER
    // ==========================
    async function renderHome() {
      const grid = document.getElementById("homeGrid");
      grid.innerHTML = "";

      for (const key of listKeys) {
        const card = document.createElement("div");
        card.className = "card";
        card.onclick = () => openView(key);

        const items = lists[key] || [];
        const preview = items.slice(0, 5);

        const bgUrl = getBackgroundPublicUrl(key);

        card.innerHTML = `
          ${bgUrl ? `<div class="card-bg" style="background-image:url('${bgUrl}?t=${Date.now()}')"></div>` : ""}

          <h2>${listDisplayNames[key]}</h2>
          <p style="margin:0 0 10px;color:#777;font-size:13px;">ðŸ”’ Edit protected</p>

          ${
            items.length === 0
              ? `<p style="color:#777;font-size:14px;margin:0;">(empty)</p>`
              : `<ul class="small-list">
                  ${preview.map(i => `<li>${i}</li>`).join("")}
                </ul>
                ${items.length > 5 ? `<p style="margin:8px 0 0;color:#777;font-size:13px;">+ more...</p>` : ""}
               `
          }
        `;

        grid.appendChild(card);
      }
    }

    // ==========================
    // EDIT MENU
    // ==========================
    function openEditMenu() {
      let name = prompt("Which list to edit?\nBuggy, Zainab, Parth, Aakash");
      if (!name) return;

      name = name.trim().toLowerCase();

      const key = getKeyFromName(name);
      if (!key) {
        alert("Invalid name! Type: Buggy, Zainab, Parth, or Aakash");
        return;
      }

      handlePasswordThenOpenEdit(key);
    }

    function getKeyFromName(nameLower) {
      for (const key of listKeys) {
        if (listDisplayNames[key].toLowerCase() === nameLower) return key;
      }
      return null;
    }

    // ==========================
    // PASSWORD ONLY FOR EDIT
    // ==========================
    async function handlePasswordThenOpenEdit(key) {
      const savedPassword = await getListPassword(key);

      // First time: create password
      if (!savedPassword) {
        let newPass = prompt(
          "This list has no password yet.\n\nCreate a password for " +
          listDisplayNames[key] +
          " (you will need it every time you edit):"
        );

        if (!newPass) return;
        newPass = newPass.trim();

        if (newPass.length < 3) {
          alert("Password too short âŒ (minimum 3 characters)");
          return;
        }

        const ok = await setListPassword(key, newPass);
        if (!ok) return;

        alert("Password created âœ…\nNow you can edit this list.");
        openEdit(key);
        return;
      }

      // Next times: ask password
      let entered = prompt("Enter password to edit " + listDisplayNames[key] + ":");
      if (!entered) return;

      entered = entered.trim();

      if (entered !== savedPassword) {
        alert("Wrong password âŒ");
        return;
      }

      openEdit(key);
    }

    // ==========================
    // OPEN SCREENS
    // ==========================
    async function openEdit(key) {
      currentListKey = key;
      hideAllScreens();
      document.getElementById("editScreen").classList.remove("hidden");

      await applyListScreenBackground(key);

      document.getElementById("editTitle").innerText = "Editing " + listDisplayNames[key];
      renderEdit();

      document.getElementById("editItemInput").focus();
    }

    async function openView(key) {
      currentListKey = key;
      hideAllScreens();
      document.getElementById("viewScreen").classList.remove("hidden");

      await applyListScreenBackground(key);

      document.getElementById("viewTitle").innerText = "Viewing " + listDisplayNames[key];
      renderView();
    }

    // ==========================
    // LIST RENDER
    // ==========================
    function renderEdit() {
      const ul = document.getElementById("editList");
      ul.innerHTML = "";

      const items = lists[currentListKey] || [];

      items.forEach((item, index) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <span>${item}</span>
          <button class="delete-btn" onclick="deleteItem(${index})">Delete</button>
        `;
        ul.appendChild(li);
      });
    }

    function renderView() {
      const ul = document.getElementById("viewList");
      ul.innerHTML = "";

      const items = lists[currentListKey] || [];

      if (items.length === 0) {
        ul.innerHTML = `<li><span style="color:#777;">(empty)</span></li>`;
        return;
      }

      items.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${item}</span>`;
        ul.appendChild(li);
      });
    }

    // ==========================
    // ADD / DELETE
    // ==========================
    async function addItem() {
      const input = document.getElementById("editItemInput");
      const value = input.value.trim();
      if (value === "") return;

      if (!lists[currentListKey]) lists[currentListKey] = [];
      lists[currentListKey].push(value);

      input.value = "";
      input.focus();
      renderEdit();

      await saveOneListToSupabase(currentListKey);
      await renderHome();
    }

    async function deleteItem(index) {
      lists[currentListKey].splice(index, 1);
      renderEdit();

      await saveOneListToSupabase(currentListKey);
      await renderHome();
    }

    // ==========================
    // BACKGROUND: GALLERY PICKER
    // ==========================
    function chooseBackgroundFromGallery() {
      const fileInput = document.getElementById("bgFileInput");
      fileInput.value = "";
      fileInput.click();
    }

    document.getElementById("bgFileInput").addEventListener("change", async function(e) {
      const file = e.target.files[0];
      if (!file) return;

      if (!file.type.startsWith("image/")) {
        alert("Please select an image file.");
        return;
      }

      const ok = await uploadBackgroundToSupabase(currentListKey, file);
      if (!ok) return;

      await applyListScreenBackground(currentListKey);
      await renderHome();
      alert("Background updated âœ…");
    });

    async function removeListBackground() {
      if (!confirm("Remove background for " + listDisplayNames[currentListKey] + "?")) return;

      const ok = await deleteBackgroundFromSupabase(currentListKey);
      if (!ok) return;

      await applyListScreenBackground(currentListKey);
      await renderHome();
      alert("Background removed âœ…");
    }

    // ==========================
    // HOME
    // ==========================
    async function goHome() {
      currentListKey = null;
      hideAllScreens();
      document.getElementById("homeScreen").classList.remove("hidden");
      await renderHome();
    }

    // Enter key adds item
    document.getElementById("editItemInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") addItem();
    });

    // ==========================
    // START APP
    // ==========================
    (async () => {
      console.log("App starting...");
      await loadAllListsFromSupabase();
      await renderHome();
      console.log("App loaded!");
    })();
  </script>

</body>
</html>











